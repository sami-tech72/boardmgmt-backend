<div #modalEl class="modal fade" tabindex="-1" aria-labelledby="createVoteLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="createVoteLabel" class="modal-title">
          <i class="fas fa-plus me-2"></i>Create Vote
        </h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="close()"></button>
      </div>

      <div class="modal-body">
        <!-- Title -->
        <div class="mb-3">
          <label class="form-label">Title <span class="text-danger">*</span></label>
          <input
            class="form-control"
            [(ngModel)]="title"
            maxlength="160"
            placeholder="Short question or decision statement"
          />
         <div class="form-text">{{ 160 - title.length }} characters left</div>
        </div>

        <!-- Description -->
        <div class="mb-3">
          <label class="form-label">Description</label>
          <textarea
            class="form-control"
            rows="3"
            [(ngModel)]="description"
            maxlength="2000"
            placeholder="Optional details, context, or attachments references"
          ></textarea>
        </div>

        <!-- Type + Deadline -->
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Vote Type</label>
            <select class="form-select" [(ngModel)]="type" (change)="onTypeChange()">
              <option [ngValue]="VoteType.YesNo">Yes / No / Abstain</option>
              <option [ngValue]="VoteType.ApproveReject">Approve / Reject / Abstain</option>
              <option [ngValue]="VoteType.MultipleChoice">Multiple choice</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Deadline <span class="text-danger">*</span></label>
            <input
              type="datetime-local"
              class="form-control"
              [(ngModel)]="deadlineLocal"
              [min]="minDeadline"
            />
            <div class="form-text">Voting closes at this time.</div>
          </div>
        </div>

        <!-- Toggles -->
        <div class="row g-3 mt-1">
          <div class="col-md-4 form-check mt-3">
            <input
              id="allowAbstain"
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="allowAbstain"
              [disabled]="type===VoteType.MultipleChoice"
            />
            <label for="allowAbstain" class="form-check-label">Allow Abstain</label>
          </div>
          <div class="col-md-4 form-check mt-3">
            <input
              id="anonymous"
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="anonymous"
            />
            <label for="anonymous" class="form-check-label">Anonymous ballots</label>
          </div>
        </div>

        <!-- Multiple Choice options -->
        <div class="mt-3" *ngIf="type===VoteType.MultipleChoice">
          <label class="form-label">Options <span class="text-danger">*</span></label>
          <div class="d-grid gap-2">
            <div class="input-group" *ngFor="let o of options; let i = index">
              <span class="input-group-text">{{ i + 1 }}</span>
              <input
                class="form-control"
                [(ngModel)]="options[i]"
                maxlength="200"
                placeholder="Option text"
              />
              <button
                class="btn btn-outline-secondary"
                type="button"
                (click)="removeOption(i)"
                [disabled]="options.length<=2"
              >
                <i class="fas fa-trash"></i>
              </button>
            </div>
            <button class="btn btn-light" type="button" (click)="addOption()">
              <i class="fas fa-plus me-1"></i>Add option
            </button>
          </div>
          <div class="form-text">Provide at least two options.</div>
        </div>

        <hr class="my-4" />

        <!-- Eligibility segmented control -->
        <label class="form-label">Who can vote? <span class="text-danger">*</span></label>
        <div class="btn-group w-100 mb-3" role="group">
          <input
            type="radio"
            class="btn-check"
            id="elig-public"
            name="elig"
            [value]="VoteEligibility.Public"
            [(ngModel)]="eligibility"
            (change)="onEligibilityChange()"
          />
          <label class="btn btn-outline-primary" for="elig-public">
            <i class="fas fa-globe me-1"></i>Public
          </label>

          <input
            type="radio"
            class="btn-check"
            id="elig-meeting"
            name="elig"
            [value]="VoteEligibility.MeetingAttendees"
            [(ngModel)]="eligibility"
            (change)="onEligibilityChange()"
          />
          <label class="btn btn-outline-primary" for="elig-meeting">
            <i class="fas fa-users me-1"></i>Meeting attendees
          </label>

          <input
            type="radio"
            class="btn-check"
            id="elig-specific"
            name="elig"
            [value]="VoteEligibility.SpecificUsers"
            [(ngModel)]="eligibility"
            (change)="onEligibilityChange()"
          />
          <label class="btn btn-outline-primary" for="elig-specific">
            <i class="fas fa-user-check me-1"></i>Specific users
          </label>
        </div>

        <!-- Meeting picker (shown for MeetingAttendees AND SpecificUsers) -->
        <div *ngIf="eligibility!==VoteEligibility.Public" class="mb-3">
          <label class="form-label">
            Select meeting
            <span *ngIf="eligibility===VoteEligibility.MeetingAttendees" class="text-danger"
              >*</span
            >
          </label>
          <select class="form-select" [(ngModel)]="meetingId" (change)="onMeetingChange()">
            <option [ngValue]="''">— Select a meeting —</option>
            <option *ngFor="let m of meetings" [ngValue]="m.id">
              {{ m.title }} — {{ m.scheduledAt | date:'medium' }}
            </option>
          </select>
          <div class="form-text" *ngIf="eligibility===VoteEligibility.SpecificUsers">
            Selecting a meeting lets you quickly pick from its attendees (optional).
          </div>
          <div class="form-text" *ngIf="eligibility===VoteEligibility.MeetingAttendees">
            Only attendees of the chosen meeting will be eligible.
          </div>
        </div>

        <!-- Attendees list -->
        <div
          class="mb-3"
          *ngIf="(eligibility===VoteEligibility.MeetingAttendees) || (eligibility===VoteEligibility.SpecificUsers && meetingId)"
        >
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label m-0">Meeting attendees</label>
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary"
              *ngIf="eligibility===VoteEligibility.SpecificUsers && attendees.length"
              (click)="addAllAttendeesToSpecific()"
            >
              Add all to Specific Users
            </button>
          </div>

          <div *ngIf="loadingAttendees" class="text-muted small">Loading attendees…</div>
          <div *ngIf="!loadingAttendees && !attendees.length" class="text-muted small">
            No attendees found.
          </div>

          <div class="attendee-grid" *ngIf="attendees.length">
            <label class="form-check form-check-inline" *ngFor="let a of attendees; trackBy: byId">
              <input
                class="form-check-input"
                type="checkbox"
                #cb
                [checked]="isAttendeeChecked(a)"
                [disabled]="eligibility===VoteEligibility.MeetingAttendees"
                (change)="onAttendeeToggled(a, cb.checked)"
              />
              <span class="form-check-label">
                {{ a.name }} <small *ngIf="a.role" class="text-muted">({{ a.role }})</small>
              </span>
            </label>
          </div>
        </div>

        <!-- Specific users picker (typeahead) -->
        <div *ngIf="eligibility===VoteEligibility.SpecificUsers" class="mb-3">
          <label class="form-label">Add users <span class="text-danger">*</span></label>
          <div class="input-group mb-2">
            <input
              class="form-control"
              [(ngModel)]="userSearch"
              (input)="onSearchUsers()"
              placeholder="Search by name or email…"
            />
            <button class="btn btn-outline-secondary" type="button" (click)="onSearchUsers()">
              <i class="fas fa-search"></i>
            </button>
          </div>

          <div class="list-group mb-2" *ngIf="userResults.length">
            <button
              type="button"
              class="list-group-item list-group-item-action"
              *ngFor="let u of userResults"
              (click)="addUserFromSearch(u)"
            >
              <i class="fas fa-user-plus me-2"></i>{{ u.displayName || u.userName || u.email || u.id
              }}
              <small class="text-muted" *ngIf="u.email && (u.displayName || u.userName)"
                >({{ u.email }})</small
              >
            </button>
          </div>

          <!-- Selected chips -->
          <div class="d-flex flex-wrap gap-2" *ngIf="selectedUsers.length">
            <span
              class="badge bg-secondary d-flex align-items-center"
              *ngFor="let s of selectedUsers"
            >
              <i class="fas fa-user me-1"></i>{{ s.display }}
              <button
                class="btn btn-sm btn-link text-white ms-2 p-0"
                (click)="removeSelectedUser(s.id)"
              >
                <i class="fas fa-times"></i>
              </button>
            </span>
          </div>

          <div class="form-text">These users (plus the creator) will be eligible.</div>
        </div>
      </div>

      <div class="modal-footer">
        <div class="me-auto text-muted small" *ngIf="!canSubmit">
          Please complete required fields (Title, Deadline, and valid options / selection).
        </div>
        <button class="btn btn-light" type="button" (click)="close()">Cancel</button>
        <button class="btn btn-primary" [disabled]="!canSubmit" (click)="create()">
          <i class="fas fa-save me-2"></i>Create
        </button>
      </div>
    </div>
  </div>
</div>
