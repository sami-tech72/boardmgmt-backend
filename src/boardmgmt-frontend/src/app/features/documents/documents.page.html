<!-- Top Navigation -->
<div
  class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 top-navbar"
>
  <h1 class="h2">Documents</h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    <div class="btn-group me-2">
      <button type="button" class="btn btn-primary" (click)="openUpload()">
        <i class="fas fa-upload"></i> Upload Document
      </button>
      <button type="button" class="btn btn-outline-secondary" (click)="createFolder()">
        <i class="fas fa-folder-plus"></i> New Folder
      </button>
    </div>
    <app-user-menu [displayName]="'John Doe'" (logout)="onLogout()"></app-user-menu>
  </div>
</div>

<!-- Filters -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <div class="row align-items-center g-2">
          <!-- Folder -->
          <div class="col-md-2">
            <select
              *ngIf="foldersLoaded"
              class="form-select"
              [ngModel]="folderSlug()"
              (ngModelChange)="folderSlug.set($event); onFiltersChanged()"
            >
              <option value="">All Folders</option>
              <option *ngFor="let f of folders" [value]="f.slug">{{ f.name }}</option>
            </select>
          </div>

          <!-- Type -->
          <div class="col-md-2">
            <select
              class="form-select"
              [ngModel]="type()"
              (ngModelChange)="type.set($event); onFiltersChanged()"
            >
              <option value="">All Types</option>
              <option value="pdf">PDF</option>
              <option value="word">Word</option>
              <option value="excel">Excel</option>
              <option value="powerpoint">PowerPoint</option>
            </select>
          </div>

          <!-- Date -->
          <div class="col-md-2">
            <select
              class="form-select"
              [ngModel]="datePreset()"
              (ngModelChange)="datePreset.set($event); onFiltersChanged()"
            >
              <option value="">All Dates</option>
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
            </select>
          </div>

          <!-- Search -->
          <div class="col-md-4">
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                placeholder="Search documents..."
                [ngModel]="search()"
                (ngModelChange)="search.set($event)"
              />
              <button class="btn btn-outline-secondary" type="button" (click)="onFiltersChanged()">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>

          <!-- View toggle -->
          <div class="col-md-2">
            <div class="btn-group w-100" role="group">
              <button
                class="btn btn-outline-secondary"
                [class.active]="viewMode() === 'grid'"
                (click)="viewMode.set('grid')"
              >
                <i class="fas fa-th"></i>
              </button>
              <button
                class="btn btn-outline-secondary"
                [class.active]="viewMode() === 'list'"
                (click)="viewMode.set('list')"
              >
                <i class="fas fa-list"></i>
              </button>
            </div>
          </div>
        </div>
        <!-- row -->
      </div>
    </div>
  </div>
</div>

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="" (click)="$event.preventDefault(); folderSlug.set(''); onFiltersChanged()"
        >Documents</a
      >
    </li>
    <li class="breadcrumb-item active" aria-current="page">{{ currentFolderName() }}</li>
  </ol>
</nav>

<!-- Grid View -->
<div *ngIf="viewMode() === 'grid'" id="documentsGrid" class="row">
  <!-- Back bar when inside a folder -->
  <div class="col-12 mb-3" *ngIf="folderSlug()">
    <button class="btn btn-outline-secondary" (click)="folderSlug.set(''); onFiltersChanged()">
      <i class="fas fa-arrow-left me-1"></i> Back to All Folders
    </button>
    <span class="ms-3 text-muted">Viewing: {{ currentFolderName() }}</span>
  </div>

  <!-- Folders (top level) -->
  <ng-container *ngIf="!folderSlug()">
    <!-- <div class="col-lg-3 col-md-4 col-sm-6 mb-4" *ngFor="let f of folders" attr.data-type="folder"> -->
      <div class="col-lg-3 col-md-4 col-sm-6 mb-4" *ngFor="let f of folders" data-type="folder">
      <div
        class="card document-card folder-card"
        (click)="folderSlug.set(f.slug); onFiltersChanged()"
      >
        <div class="card-body text-center">
          <i
            class="fa-3x mb-3"
            [ngClass]="[styleForFolder(f).iconClass, styleForFolder(f).colorClass]"
          ></i>
          <h6 class="card-title">{{ f.name }}</h6>
          <small class="text-muted">{{ f.documentCount }} documents</small>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- Documents -->
  <div
    class="col-lg-3 col-md-4 col-sm-6 mb-4"
    *ngFor="let d of docs"
    [attr.data-type]="typeFor(d)"
    [attr.data-folder]="d.folderSlug || 'root'"
  >
    <div class="card document-card">
      <div class="card-body text-center">
        <div class="doc-icon mx-auto mb-3" [ngClass]="typeFor(d)">
          <i class="fas" [ngClass]="faIconFor(d)"></i>
        </div>
        <h6 class="card-title text-truncate" title="{{ d.originalName }}">{{ d.originalName }}</h6>
          <small class="text-muted">
            {{ prettySize(d.sizeBytes) }} • {{ d.uploadedAt | date:'short' }}
          </small>

        <div class="mt-3">
          <div class="btn-group" role="group">
            <button class="btn btn-sm btn-primary" type="button" (click)="viewDocument(d)">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-sm btn-success" type="button" (click)="downloadDocument(d)">
              <i class="fas fa-download"></i>
            </button>
            <button
              class="btn btn-sm btn-outline-secondary"
              type="button"
              (click)="shareDocument(d)"
            >
              <i class="fas fa-share"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- List View -->
<div *ngIf="viewMode() === 'list'" id="documentsList" class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table
        class="table table-hover align-middle"
        [dataTableSource]="docs"
        [appDataTable]="{ perPage: 12, labels: { searchPlaceholder: 'Search documents…' } }"
      >
        <thead>
          <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Size</th>
            <th>Modified</th>
            <th class="text-end no-sort">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let d of docs">
            <td>
              <div class="d-flex align-items-center">
                <div class="doc-icon me-3" [ngClass]="typeFor(d)">
                  <i class="fas" [ngClass]="faIconFor(d)"></i>
                </div>
                <div>
                  <h6
                    class="mb-0 text-truncate"
                    style="max-width: 320px"
                    title="{{ d.originalName }}"
                  >
                    {{ d.originalName }}
                  </h6>
                  <small class="text-muted">{{ d.folderSlug || 'root' }}</small>
                </div>
              </div>
            </td>
            <td>
              <span class="badge bg-secondary"
                >{{ d.contentType.split('/')[1] || d.contentType }}</span
              >
            </td>
           <td>{{ prettySize(d.sizeBytes) }}</td>
            <td>{{ d.uploadedAt | date:'short' }}</td>
            <td class="text-end">
              <div class="btn-group" role="group">
                <button class="btn btn-sm btn-primary" type="button" (click)="viewDocument(d)">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-success" type="button" (click)="downloadDocument(d)">
                  <i class="fas fa-download"></i>
                </button>
                <button
                  class="btn btn-sm btn-outline-secondary"
                  type="button"
                  (click)="shareDocument(d)"
                >
                  <i class="fas fa-share"></i>
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="!docs.length" data-dt-placeholder>
            <td colspan="5" class="text-center text-muted py-4">No documents available.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modals -->
<app-upload-document-modal (uploaded)="refreshDocs()"></app-upload-document-modal>
<app-new-folder-modal
  [existingSlugs]="existingFolderSlugs"
  (create)="onFolderCreate($event)"
></app-new-folder-modal>

<!-- Viewer modal (no replace-file UI here) -->
<app-document-viewer-modal
  [doc]="selectedDoc()"
  (closed)="onViewerClosed()"
  (updated)="refreshDocs()"
  (deleted)="refreshDocs()"
  (editRequested)="onEditRequested($event)"
></app-document-viewer-modal>
